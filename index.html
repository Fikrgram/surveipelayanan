<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>SIPUS â€“ Survei Indeks Pelayanan Perpustakaan</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
    canvas {
      max-width: 100% !important;
      height: auto !important;
    }
    /* Animasi Floating */
    @keyframes bubbleFloat {
      0% { transform: translateY(0) scale(1); }
      50% { transform: translateY(-4px) scale(1.05); }
      100% { transform: translateY(0) scale(1); }
    }
    /* Bubble Rating Style */
    .rating-bubble {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
      color: #1e3a8a;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.25s ease;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
      cursor: pointer;
      font-size: 14px;
      animation: bubbleFloat 2.5s ease-in-out infinite;
    }
    .rating-bubble:hover {
      transform: scale(1.1);
      background: linear-gradient(135deg, #93c5fd, #60a5fa);
      color: white;
      box-shadow: 0 0 12px rgba(59,130,246,0.6);
      animation: none; /* stop animasi saat hover */
    }
    .rating-bubble.active {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: white;
      transform: scale(1.15);
      box-shadow: 0 0 15px rgba(37,99,235,0.6);
    }
</style>
</head>
<body class="bg-gradient-to-tr from-blue-50 to-white min-h-screen">
<header class="bg-blue-700 text-white py-8 px-6 text-center shadow-md rounded-b-3xl">
<div class="flex flex-col items-center space-y-3">
<img alt="Logo" class="w-24 h-24 rounded-full border-4 border-white shadow-md" src="Sipus.png"/>
<h1 class="text-3xl font-bold">Survei Indeks Pelayanan Perpustakaan</h1>
<p class="text-base font-semibold">SIPUS</p>
</div>
</header>

<!-- Mobile -->
<section class="sm:hidden text-center px-6 py-10 bg-gradient-to-tr from-blue-100 to-white rounded-3xl shadow-md mx-4 mt-6">
<h1 class="text-2xl font-bold text-blue-700 mb-2">Survei Indeks Pelayanan</h1>
<p class="text-gray-600 mb-4">Bantu kami meningkatkan layanan perpustakaan ðŸ’¬</p>
<button class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-8 rounded-full shadow-md transition-all duration-300 ease-in-out hover:scale-105" onclick="mulaiSurvei()">Mulai Survei</button>
</section>

<!-- Desktop Chart Awal -->
<section class="hidden sm:block max-w-3xl mx-auto mt-8 p-6 bg-gradient-to-tr from-blue-100 to-white shadow-md rounded-2xl" id="chartAwalSection">
<h2 class="text-lg font-semibold mb-2 text-center text-blue-700">Rata-rata Kepuasan Responden Sebelumnya</h2>
<p class="text-center text-sm text-gray-600 mb-4" id="jumlahRespondenText">Memuat data responden...</p>
<div class="w-full sm:w-2/3 md:w-1/2 mx-auto">
<canvas id="chartAwal"></canvas>
</div>
<div class="text-center mt-6">
  <button class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-8 rounded-full shadow-md transition-all duration-300 ease-in-out hover:scale-105" onclick="mulaiSurvei()">Mulai Survei</button>
</div>
</section>

<!-- Survey Section -->
<main class="max-w-4xl mx-auto p-6 bg-white shadow-xl mt-8 rounded-3xl hidden" id="surveySection">
<div class="w-full bg-gray-200 rounded-full h-2.5 mb-6">
<div class="bg-blue-600 h-2.5 rounded-full transition-all duration-500" id="progressBar" style="width: 0%;"></div>
</div>
<form id="surveyForm">
<div id="step-container"></div>
<div class="flex justify-between mt-6">
<button class="bg-gray-300 text-gray-700 px-5 py-2 rounded-xl font-medium hidden hover:bg-gray-400" id="prevBtn" type="button">Sebelumnya</button>
<button class="bg-blue-600 text-white px-5 py-2 rounded-xl font-medium hover:bg-blue-700" id="nextBtn" type="button">Selanjutnya</button>
</div>
<div class="mt-6 hidden" id="submitSection">
<label class="block mb-2 font-medium">Komentar (Opsional)</label>
<textarea class="w-full border border-gray-300 p-3 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-300" name="komentar" placeholder="Tulis komentar Anda..." rows="3"></textarea>
<button class="bg-green-600 text-white px-5 py-2 rounded-xl font-medium hover:bg-green-700 w-full" id="submitBtn" type="submit">Kirim</button>
</div>
</form>
</main>

<!-- Result Section -->
<section class="max-w-3xl mx-auto mt-10 p-6 bg-white shadow-md rounded-2xl hidden" id="resultSection">
<h2 class="text-lg font-semibold mb-4 text-center text-blue-700">Hasil Rata-rata Kepuasan Anda</h2>
<canvas id="chartKepuasan"></canvas>
</section>

<script>
    function playSuccessSound() {
      const sound = document.getElementById("successSound");
      if (sound) {
        sound.currentTime = 0;
        sound.play();
      }
    }
    function playClickSound() {
      const sound = document.getElementById("clickSound");
      if (sound) {
        sound.currentTime = 0;
        sound.play();
      }
    }

    const firebaseConfig = {
      apiKey: "AIzaSyCI_FrDaO-FuMeJvQxvACKqLJrsHI_tHWg",
      authDomain: "survei-pelayanan.firebaseapp.com",
      databaseURL: "https://survei-pelayanan-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "survei-pelayanan",
      storageBucket: "survei-pelayanan.appspot.com",
      messagingSenderId: "147429967408",
      appId: "1:147429967408:web:a00cc6db64b1125c778ff5"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const aspekList = [
      { judul: "Keramahan Petugas", prefix: "keramahan", pertanyaan: ["Petugas menyambut dengan ramah", "Petugas menjawab dengan sopan", "Petugas sigap membantu", "Nyaman berinteraksi dengan petugas", "Informasi dari petugas lengkap"] },
      { judul: "Fasilitas Ruang Baca", prefix: "fasilitas", pertanyaan: ["Kursi dan meja nyaman", "Pencahayaan cukup", "Colokan listrik tersedia", "Area baca inklusif", "Nyaman untuk waktu lama"] },
      { judul: "Koleksi Buku", prefix: "koleksi", pertanyaan: ["Buku yang dicari tersedia", "Koleksi selalu diperbarui", "Penyusunan buku rapi", "Kategori buku beragam", "Kondisi fisik buku baik"] },
      { judul: "Kebersihan dan Kenyamanan", prefix: "kebersihan", pertanyaan: ["Ruangan bersih dan terawat", "Toilet bersih", "Udara nyaman", "Tempat sampah tersedia", "Lingkungan mendukung belajar"] },
      { judul: "Proses Layanan", prefix: "layanan", pertanyaan: ["Peminjaman cepat dan mudah", "Aturan dijelaskan jelas", "Dapat notifikasi pengembalian", "Pengembalian mudah", "Sistem layanan online lancar"] }
    ];

    let currentStep = 0;
    const stepContainer = document.getElementById("step-container");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const submitSection = document.getElementById("submitSection");
    const resultSection = document.getElementById("resultSection");
    const jawaban = {};

    function renderStep(step) {
      stepContainer.innerHTML = `<h3 class="text-blue-600 font-bold text-xl mb-6 text-center">${aspekList[step].judul}</h3>`;
      aspekList[step].pertanyaan.forEach((text, index) => {
        const id = `${aspekList[step].prefix}${index + 1}`;
        jawaban[id] = jawaban[id] || 0;
        stepContainer.innerHTML += `
          <div class="mb-6 bg-white p-4 rounded-2xl shadow">
            <label class="block font-medium mb-3">${text}</label>
            <div class="flex flex-wrap gap-3 justify-center sm:justify-start">
              ${[...Array(10)].map((_, i) => `
                <div type="button" data-id="${id}" data-val="${i + 1}" 
                  class="rating-bubble ${jawaban[id] === i + 1 ? 'active' : ''}">
                  ${i + 1}
                </div>
              `).join('')}
            </div>
          </div>
        `;
      });
      document.querySelectorAll(".rating-bubble").forEach(btn => {
        btn.addEventListener("click", () => {
          playClickSound();
          const id = btn.dataset.id;
          const val = parseInt(btn.dataset.val);
          jawaban[id] = val;
          document.querySelectorAll(`[data-id='${id}']`).forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
        });
      });
      prevBtn.classList.toggle("hidden", step === 0);
      nextBtn.textContent = step === aspekList.length - 1 ? "Selesai" : "Selanjutnya";
      updateProgressBar();
    }

    function updateProgressBar() {
      const progress = ((currentStep + 1) / aspekList.length) * 100;
      document.getElementById("progressBar").style.width = `${progress}%`;
    }

    nextBtn.addEventListener("click", () => {
      playClickSound();
      if (currentStep < aspekList.length - 1) {
        currentStep++;
        renderStep(currentStep);
      } else {
        stepContainer.classList.add("hidden");
        nextBtn.classList.add("hidden");
        prevBtn.classList.add("hidden");
        submitSection.classList.remove("hidden");
      }
    });

    prevBtn.addEventListener("click", () => {
      playClickSound();
      if (currentStep > 0) {
        currentStep--;
        renderStep(currentStep);
      }
    });

    document.getElementById("surveyForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const submitBtn = document.getElementById("submitBtn");
      const komentarField = this.komentar;

      submitBtn.disabled = true;
      submitBtn.textContent = "Mengirim...";
      playClickSound();

      const hasil = aspekList.map(aspek => {
        let total = 0;
        for (let i = 1; i <= 5; i++) {
          total += jawaban[`${aspek.prefix}${i}`] * 10;
        }
        return Math.round(total / 5);
      });

      const dataKirim = {
        waktu: new Date().toISOString(),
        komentar: komentarField.value,
        hasil: {},
        jawaban: { ...jawaban }
      };
      aspekList.forEach((aspek, index) => {
        dataKirim.hasil[aspek.prefix] = hasil[index];
      });

      try {
        await database.ref('respon_survei').push(dataKirim);
        playSuccessSound();
        alert("Data berhasil dikirim!");
        komentarField.value = "";
        komentarField.disabled = true;
        submitBtn.textContent = "Terkirim";
        submitBtn.classList.add("bg-gray-400");
        submitBtn.classList.remove("bg-green-600", "hover:bg-green-700");
        submitSection.classList.add("hidden");
      } catch (error) {
        console.error("Gagal kirim ke Firebase:", error);
        alert("Terjadi kesalahan saat mengirim data.");
        submitBtn.disabled = false;
        submitBtn.textContent = "Kirim";
        return;
      }

      resultSection.classList.remove("hidden");
      const ctx = document.getElementById("chartKepuasan").getContext("2d");
      new Chart(ctx, {
        type: "bar",
        data: {
          labels: aspekList.map(a => a.judul.split(" ")[0]),
          datasets: [{
            label: "Rata-rata (%)",
            data: hasil,
            backgroundColor: ["#3B82F6", "#10B981", "#F59E0B", "#EC4899", "#6366F1"]
          }]
        },
        options: {
          scales: { y: { beginAtZero: true, max: 100 } }
        }
      });

      setTimeout(() => {
        resultSection.scrollIntoView({ behavior: "smooth" });
      }, 300);
    });

    async function tampilkanChartAwalDariFirebase() {
      const snapshot = await database.ref('respon_survei').once('value');
      const data = snapshot.val();
      if (!data) return;
      const total = [0, 0, 0, 0, 0];
      let jumlahResponden = 0;
      Object.values(data).forEach(item => {
        if (!item.hasil) return;
        total[0] += item.hasil.keramahan || 0;
        total[1] += item.hasil.fasilitas || 0;
        total[2] += item.hasil.koleksi || 0;
        total[3] += item.hasil.kebersihan || 0;
        total[4] += item.hasil.layanan || 0;
        jumlahResponden++;
      });
      if (jumlahResponden === 0) return;
      const rataRata = total.map(nilai => Math.round(nilai / jumlahResponden));
      document.getElementById("jumlahRespondenText").textContent = `Total responden: ${jumlahResponden} orang`;
      const ctx = document.getElementById("chartAwal").getContext("2d");
      new Chart(ctx, {
        type: "pie",
        data: {
          labels: ["Keramahan", "Fasilitas", "Koleksi", "Kebersihan", "Layanan"],
          datasets: [{
            label: "Responden Sebelumnya (%)",
            data: rataRata,
            backgroundColor: ["#3B82F6", "#10B981", "#F59E0B", "#EC4899", "#6366F1"]
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: "bottom" } }
        }
      });
    }

    function mulaiSurvei() {
      playClickSound();
      document.getElementById("chartAwalSection").classList.add("hidden");
      document.getElementById("surveySection").classList.remove("hidden");
      document.getElementById("surveySection").scrollIntoView({ behavior: "smooth" });
    }

    window.addEventListener("load", tampilkanChartAwalDariFirebase);
    renderStep(currentStep);
</script>
<audio id="clickSound" preload="auto" src="klik.mp3"></audio>
<audio id="successSound" preload="auto" src="selesai.mp3"></audio>
</body>
</html>
