<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>SIPUS – Survei Indeks Pelayanan Perpustakaan</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  color: #333;
  overflow-x: hidden;
}

.container {
  max-width: 900px;
  margin: 0 auto;
  padding: 20px;
}

/* Header Section */
.header {
  text-align: center;
  padding: 40px 0;
  color: white;
  position: relative;
}

.logo {
  width: 80px;
  height: 80px;
  background: rgba(255,255,255,0.2);
  border-radius: 50%;
  margin: 0 auto 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 32px;
  backdrop-filter: blur(10px);
  border: 2px solid rgba(255,255,255,0.3);
}

.title {
  font-size: 2.5rem;
  font-weight: 700;
  margin-bottom: 10px;
  letter-spacing: -0.5px;
}

.subtitle {
  font-size: 1.1rem;
  opacity: 0.9;
  font-weight: 300;
}

/* Admin Button */
.admin-button {
  position: absolute;
  top: 20px;
  right: 20px;
  background: rgba(255,255,255,0.2);
  color: white;
  border: 2px solid rgba(255,255,255,0.3);
  padding: 10px 20px;
  border-radius: 25px;
  cursor: pointer;
  backdrop-filter: blur(10px);
  transition: all 0.3s ease;
  font-weight: 600;
}

.admin-button:hover {
  background: rgba(255,255,255,0.3);
  transform: translateY(-2px);
}

/* Card Styles */
.card {
  background: rgba(255,255,255,0.95);
  backdrop-filter: blur(20px);
  border-radius: 24px;
  padding: 40px;
  margin: 30px 0;
  box-shadow: 0 20px 40px rgba(0,0,0,0.1);
  border: 1px solid rgba(255,255,255,0.2);
  transition: all 0.3s ease;
}

.card:hover {
  transform: translateY(-5px);
  box-shadow: 0 30px 60px rgba(0,0,0,0.15);
}

/* Welcome Screen */
.welcome-screen {
  text-align: center;
  padding: 60px 40px;
}

.welcome-title {
  font-size: 2rem;
  font-weight: 600;
  margin-bottom: 16px;
  color: #2d3748;
}

.welcome-description {
  font-size: 1.1rem;
  color: #718096;
  margin-bottom: 40px;
  line-height: 1.6;
}

.start-button {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  border: none;
  padding: 16px 40px;
  border-radius: 50px;
  font-size: 1.1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 10px 30px rgba(102,126,234,0.3);
}

.start-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 15px 35px rgba(102,126,234,0.4);
}

/* Progress Bar */
.progress-container {
  margin-bottom: 40px;
}

.progress-bar {
  width: 100%;
  height: 6px;
  background: rgba(0,0,0,0.1);
  border-radius: 3px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #667eea, #764ba2);
  border-radius: 3px;
  transition: width 0.5s ease;
  width: 0%;
}

.progress-text {
  text-align: center;
  margin-top: 10px;
  font-size: 0.9rem;
  color: #718096;
  font-weight: 500;
}

/* Survey Steps */
.step-title {
  font-size: 1.8rem;
  font-weight: 600;
  text-align: center;
  margin-bottom: 40px;
  color: #2d3748;
}

.question-card {
  background: linear-gradient(135deg, #e0e7ff, #eef2ff);
  border: 1px solid rgba(99,102,241,0.2);
  border-radius: 20px;
  padding: 30px;
  box-shadow: 0 10px 20px rgba(99,102,241,0.08);
  transition: all 0.3s ease;
}

.question-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 15px 35px rgba(99,102,241,0.15);
}

.question-text {
  font-size: 1.1rem;
  font-weight: 500;
  margin-bottom: 20px;
  color: #374151;
}

/* ENHANCED RATING CONTAINER */
.rating-container {
  display: flex;
  gap: 12px;
  justify-content: center;
  flex-wrap: wrap;
  perspective: 1000px;
  position: relative;
  background: rgba(255, 255, 255, 0.5);
  backdrop-filter: blur(10px);
  border-radius: 16px;
  padding: 15px;
  margin-top: 10px;
  box-shadow: inset 0 2px 8px rgba(0,0,0,0.05);
}

.rating-button {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  border: 2px solid #d1d5db;
  background: white;
  color: #64748b;
  font-weight: 600;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  position: relative;
  overflow: hidden;
  transform-style: preserve-3d;
}

/* Ripple Effect */
.rating-button::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  background: radial-gradient(circle, rgba(255,255,255,0.6) 0%, transparent 70%);
  border-radius: 50%;
  transform: translate(-50%, -50%);
  transition: all 0.6s ease-out;
  pointer-events: none;
}

/* Particle Effect */
.rating-button::after {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: 
    radial-gradient(circle at 20% 20%, rgba(255,255,255,0.3) 1px, transparent 1px),
    radial-gradient(circle at 80% 80%, rgba(255,255,255,0.3) 1px, transparent 1px),
    radial-gradient(circle at 40% 70%, rgba(255,255,255,0.2) 1px, transparent 1px);
  background-size: 20px 20px, 25px 25px, 15px 15px;
  opacity: 0;
  transition: all 0.8s ease-out;
  pointer-events: none;
  animation: sparkle 3s infinite;
}

@keyframes sparkle {
  0%, 100% { opacity: 0; transform: rotate(0deg); }
  50% { opacity: 1; transform: rotate(180deg); }
}

.rating-button:hover {
  border-color: #667eea;
  background: radial-gradient(circle at top left, #8b5cf6, #6366f1);
  color: white;
  transform: scale(1.15) rotate(5deg) translateY(-5px);
  box-shadow: 
    0 15px 35px rgba(102,126,234,0.4),
    0 0 30px rgba(102,126,234,0.3),
    inset 0 2px 10px rgba(255,255,255,0.2);
  z-index: 10;
}

.rating-button:hover::before {
  width: 120px;
  height: 120px;
  animation: ripple 0.6s ease-out;
}

.rating-button:hover::after {
  opacity: 0.8;
  transform: rotate(360deg) scale(1.1);
}

@keyframes ripple {
  0% { width: 0; height: 0; opacity: 1; }
  100% { width: 120px; height: 120px; opacity: 0; }
}

.rating-button.active {
  background: linear-gradient(135deg, #4f46e5, #7c3aed);
  border-color: #4f46e5;
  color: white;
  transform: scale(1.2);
  box-shadow: 0 8px 20px rgba(79,70,229,0.4);
}

.rating-button.active::after {
  opacity: 1;
  animation: sparkle 1.5s infinite;
}

@keyframes clickPulse {
  0% { transform: scale(1.2); }
  50% { transform: scale(1.4) rotateY(180deg); }
  100% { transform: scale(1.2); }
}

.rating-button.clicked {
  animation: clickPulse 0.6s ease-out;
}

/* Color Variations for Different Values */
.rating-button[data-value="1"]:hover { background: linear-gradient(135deg, #ef4444, #dc2626); }
.rating-button[data-value="2"]:hover { background: linear-gradient(135deg, #f97316, #ea580c); }
.rating-button[data-value="3"]:hover { background: linear-gradient(135deg, #f59e0b, #d97706); }
.rating-button[data-value="4"]:hover { background: linear-gradient(135deg, #eab308, #ca8a04); }
.rating-button[data-value="5"]:hover { background: linear-gradient(135deg, #84cc16, #65a30d); }
.rating-button[data-value="6"]:hover { background: linear-gradient(135deg, #22c55e, #16a34a); }
.rating-button[data-value="7"]:hover { background: linear-gradient(135deg, #06b6d4, #0891b2); }
.rating-button[data-value="8"]:hover { background: linear-gradient(135deg, #3b82f6, #2563eb); }
.rating-button[data-value="9"]:hover { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
.rating-button[data-value="10"]:hover { background: linear-gradient(135deg, #ec4899, #db2777); }

/* Navigation */
.navigation {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 40px;
  gap: 20px;
}

.nav-button {
  padding: 12px 28px;
  border-radius: 50px;
  font-weight: 600;
  border: none;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 1rem;
}

.nav-button.secondary {
  background: #f1f5f9;
  color: #64748b;
}

.nav-button.secondary:hover {
  background: #e2e8f0;
}

.nav-button.primary {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  box-shadow: 0 4px 20px rgba(102,126,234,0.3);
}

.nav-button.primary:hover {
  transform: translateY(-1px);
  box-shadow: 0 6px 25px rgba(102,126,234,0.4);
}

/* Comments Section */
.comment-section {
  padding: 40px 0;
}

.comment-label {
  font-size: 1.1rem;
  font-weight: 600;
  margin-bottom: 12px;
  color: #374151;
}

.comment-textarea {
  width: 100%;
  padding: 16px;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  font-size: 1rem;
  resize: vertical;
  min-height: 100px;
  transition: border-color 0.3s ease;
  background: #f8fafc;
}

.comment-textarea:focus {
  outline: none;
  border-color: #667eea;
  background: white;
}

.submit-button {
  width: 100%;
  padding: 16px;
  background: linear-gradient(135deg, #10b981, #059669);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 1.1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  margin-top: 20px;
}

.submit-button:hover {
  transform: translateY(-1px);
  box-shadow: 0 10px 30px rgba(16,185,129,0.3);
}

.submit-button:disabled {
  background: #9ca3af;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

/* Results Section */
.results-card {
  text-align: center;
  padding: 40px;
}

.results-title {
  font-size: 1.8rem;
  font-weight: 600;
  margin-bottom: 30px;
  color: #2d3748;
}

.chart-container {
  max-width: 500px;
  margin: 0 auto;
}

/* Stats Card */
.stats-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.stat-card {
  background: #f8fafc;
  padding: 24px;
  border-radius: 16px;
  text-align: center;
  border: 2px solid #e2e8f0;
  transition: all 0.3s ease;
}

.stat-card:hover {
  border-color: #667eea;
  transform: translateY(-2px);
}

.stat-number {
  font-size: 2rem;
  font-weight: 700;
  color: #667eea;
  margin-bottom: 8px;
}

.stat-label {
  font-size: 0.9rem;
  color: #64748b;
  font-weight: 500;
}

/* Admin Modal Styles */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.7);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  backdrop-filter: blur(5px);
}

.modal-content {
  background: white;
  border-radius: 20px;
  padding: 30px;
  max-width: 800px;
  max-height: 90vh;
  overflow-y: auto;
  width: 90%;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
  border-bottom: 2px solid #e2e8f0;
  padding-bottom: 15px;
}

.modal-title {
  font-size: 1.5rem;
  font-weight: 700;
  color: #2d3748;
}

.close-btn {
  background: #ef4444;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
}

.close-btn:hover {
  background: #dc2626;
}

.admin-section {
  margin-bottom: 30px;
}

.admin-section h3 {
  font-size: 1.2rem;
  font-weight: 600;
  color: #4f46e5;
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.question-editor {
  background: #f8fafc;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  padding: 15px;
  margin-bottom: 15px;
}

.question-editor label {
  font-weight: 600;
  color: #374151;
  display: block;
  margin-bottom: 8px;
}

.question-input {
  width: 100%;
  padding: 12px;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  font-size: 1rem;
  transition: border-color 0.3s ease;
}

.question-input:focus {
  outline: none;
  border-color: #4f46e5;
  box-shadow: 0 0 0 3px rgba(79,70,229,0.1);
}

.save-btn {
  background: linear-gradient(135deg, #10b981, #059669);
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.save-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 5px 15px rgba(16,185,129,0.3);
}

.admin-password {
  background: #f8fafc;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  padding: 20px;
  text-align: center;
}

.password-input {
  padding: 12px;
  border: 2px solid #d1d5db;
  border-radius: 8px;
  font-size: 1rem;
  margin: 0 10px;
  width: 200px;
}

.login-btn {
  background: linear-gradient(135deg, #4f46e5, #7c3aed);
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
}

/* Mobile Responsiveness */
@media (max-width: 768px) {
  .container {
    padding: 15px;
  }
  
  .card {
    padding: 24px;
    margin: 20px 0;
  }
  
  .title {
    font-size: 2rem;
  }
  
  .welcome-screen {
    padding: 40px 24px;
  }
  
  .rating-container {
    gap: 8px;
  }
  
  .rating-button {
    width: 38px;
    height: 38px;
    font-size: 0.9rem;
  }
  
  .rating-button:hover {
    transform: scale(1.1) translateY(-2px);
  }
  
  .navigation {
    flex-direction: column-reverse;
    gap: 12px;
  }
  
  .nav-button {
    width: 100%;
  }

  .admin-button {
    display: none;
  }

  .modal-content {
    width: 95%;
    padding: 20px;
  }
}

/* Animations */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes slideIn {
  from { opacity: 0; transform: translateX(-20px); }
  to { opacity: 1; transform: translateX(0); }
}

.card {
  animation: fadeIn 0.6s ease-out;
}

.question-card {
  animation: slideIn 0.4s ease-out;
}

.hidden {
  display: none !important;
}
</style>
</head>

<body>
  
<audio id="klikSound" src="klik.mp3" preload="auto"></audio>
<audio id="selesaiSound" src="selesai.mp3" preload="auto"></audio>

<!-- Admin Modal -->
<div id="adminModal" class="modal hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Admin Panel - Editor Pertanyaan</h2>
      <button class="close-btn" onclick="closeAdmin()">✕ Tutup</button>
    </div>
    
    <div id="adminLogin" class="admin-password">
      <h3>🔒 Masukkan Password Admin</h3>
      <div style="margin: 20px 0;">
        <input type="password" id="adminPasswordInput" class="password-input" placeholder="Password Admin">
        <button class="login-btn" onclick="loginAdmin()">Login</button>
      </div>
    </div>

    <div id="adminContent" class="hidden">
      <div id="adminEditor"></div>
      <div style="text-align: center; margin-top: 30px;">
        <button class="save-btn" onclick="saveQuestions()">💾 Simpan Semua Perubahan</button>
      </div>
    </div>
  </div>
</div>

<!-- Onboarding Popup -->
<div id="onboardingModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-2xl shadow-lg p-6 max-w-sm text-center">
    <h2 class="text-xl font-bold mb-4 text-gray-800">📊 Panduan Penilaian</h2>
    <p class="text-gray-600 mb-6">
      Gunakan skala <b>1–10</b>:<br>
      <b>1</b> = nilai terendah (sangat tidak puas)<br>
      <b>10</b> = nilai tertinggi (sangat puas)
    </p>
    <button id="closeOnboarding" class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition">
      Mengerti
    </button>
  </div>
</div>

<!-- Header -->
<div class="header">
  <div class="container">
    <button class="admin-button" onclick="openAdmin()">⚙️ Admin</button>
    <div class="logo"><img src="sipus.png" alt="Logo SIPUS" style="width:90px;height:90px;border-radius:70%;"></div>
    <h1 class="title">SIPUS</h1>
    <p class="subtitle">Survei Indeks Pelayanan Perpustakaan</p>
  </div>
</div>

<div class="container">
  <!-- Welcome Screen -->
  <div class="card" id="welcomeScreen">
    <div class="welcome-screen">
      <h2 class="welcome-title">Bantu Kami Meningkatkan Layanan</h2>
      <p class="welcome-description">
        Pendapat Anda sangat berharga untuk meningkatkan kualitas layanan perpustakaan. 
        Survei ini hanya membutuhkan 3-5 menit.
      </p>
      
      <!-- Previous Stats -->
      <div class="stats-container" id="statsContainer">
        <div class="stat-card">
          <div class="stat-number" id="totalResponden">-</div>
          <div class="stat-label">Total Responden</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="avgRating">-</div>
          <div class="stat-label">Rata-rata Kepuasan</div>
        </div>
      </div>
      
      <div class="chart-container">
        <canvas id="welcomeChart"></canvas>
      </div>
      
      <button class="start-button" onclick="mulaiSurvei()">
        Mulai Survei
      </button>
    </div>
  </div>

  <!-- Survey Section -->
  <div class="card hidden" id="surveySection">
    <!-- Progress Bar -->
    <div class="progress-container">
      <div class="progress-bar">
        <div class="progress-fill" id="progressBar"></div>
      </div>
      <div class="progress-text" id="progressText">Langkah 1 dari 5</div>
    </div>

    <!-- Survey Form -->
    <form id="surveyForm">
      <div id="stepContainer"></div>
      
      <!-- Navigation -->
      <div class="navigation">
        <button type="button" class="nav-button secondary hidden" id="prevBtn">
          ← Sebelumnya
        </button>
        <button type="button" class="nav-button primary" id="nextBtn">
          Selanjutnya →
        </button>
      </div>

      <!-- Comment Section -->
      <div class="comment-section hidden" id="commentSection">
        <label class="comment-label">Komentar & Saran (Opsional)</label>
        <textarea 
          class="comment-textarea" 
          name="komentar" 
          placeholder="Bagikan pengalaman atau saran Anda untuk perbaikan layanan..."
          rows="4">
        </textarea>
        <button type="submit" class="submit-button" id="submitBtn">
          Kirim Survei
        </button>
      </div>
    </form>
  </div>

  <!-- Results Section -->
  <div class="card hidden" id="resultSection">
    <div class="results-card">
      <h2 class="results-title">Terima Kasih atas Partisipasi Anda!</h2>
      <p style="color: #64748b; margin-bottom: 30px;">
        Berikut adalah ringkasan penilaian Anda:
      </p>
      <div class="chart-container">
        <canvas id="resultChart"></canvas>
      </div>
      <p id="countdownText" style="color: #64748b; margin-top: 20px;">
        Halaman ini akan otomatis kembali ke awal dalam 15 detik.
      </p>
    </div>
  </div>
</div>

<script>
// Ambil elemen audio
const klikSound = document.getElementById('klikSound');
const selesaiSound = document.getElementById('selesaiSound');

function playKlik() {
  klikSound.currentTime = 0;
  klikSound.play().catch(() => {});
}

function playSelesai() {
  selesaiSound.currentTime = 0;
  selesaiSound.play().catch(() => {});
}

// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyCI_FrDaO-FuMeJvQxvACKqLJrsHI_tHWg",
  authDomain: "survei-pelayanan.firebaseapp.com",
  databaseURL: "https://survei-pelayanan-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "survei-pelayanan",
  storageBucket: "survei-pelayanan.appspot.com",
  messagingSenderId: "147429967408",
  appId: "1:147429967408:web:a00cc6db64b1125c778ff5"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// Default Survey Data (akan dimuat dari Firebase jika tersedia)
let aspekList = [
  { 
    judul: "Keramahan Staf", 
    prefix: "keramahan", 
    pertanyaan: [
      "Tingkat keramahan staf ketika menyambut pengunjung.",
      "Sikap sopan santun staf dalam berinteraksi.",
      "Senyuman atau sapaan staf kepada pengunjung.",
      "Sikap staf yang membuat pengunjung merasa nyaman.",
      "Konsistensi keramahan staf dari awal hingga akhir kunjungan."
    ] 
  },
  { 
    judul: "Fasilitas", 
    prefix: "fasilitas", 
    pertanyaan: [
      "Kenyamanan tempat membaca yang disediakan perpustakaan.",
      "Kemudahaan akses area parkir bagi pengunjung.",
      "Kondisi fasilitas pendukung seperti toilet atau mushola.",
      "Kemudahan penggunaan fasilitas oleh pengunjung.",
      "Kesesuaian fasilitas dengan kebutuhan pengunjung."
    ] 
  },
  { 
    judul: "Koleksi", 
    prefix: "koleksi", 
    pertanyaan: [
      "Daya tarik koleksi buku yang ditampilkan.",
      "Keragaman koleksi yang tersedia.",
      "Kesesuaian koleksi dengan harapan atau minat pengunjung.",
      "Kejelasan informasi atau penjelasan yang menyertai koleksi.",
      "Kondisi fisik koleksi (terawat, tertata, tidak rusak)."
    ] 
  },
  { 
    judul: "Kebersihan", 
    prefix: "kebersihan", 
    pertanyaan: [
      "Kebersihan area membaca untuk pemustaka.",
      "Kebersihan toilet yang tersedia.",
      "Kebersihan lantai, kaca, dan perabotan.",
      "Penanganan sampah (ketersediaan tempat sampah, tidak penuh).",
      "Kenyamanan udara dan lingkungan sekitar."
    ] 
  },
  { 
    judul: "Layanan", 
    prefix: "layanan", 
    pertanyaan: [
      "Kecepatan staf dalam merespons kebutuhan pengunjung.",
      "Kejelasan informasi yang diberikan staf.",
      "Perlakuan staf yang adil kepada semua pengunjung.",
      "Kemampuan staf membantu menyelesaikan masalah atau pertanyaan.",
      "Kepuasan pengunjung terhadap layanan secara keseluruhan."
    ] 
  }
];

// Admin Configuration
const ADMIN_PASSWORD = "admin123"; // Ganti dengan password yang lebih aman
let isAdminLoggedIn = false;

// Survey State
let currentStep = 0;
const jawaban = {};
const stepContainer = document.getElementById("stepContainer");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const commentSection = document.getElementById("commentSection");
const resultSection = document.getElementById("resultSection");

// Load Questions from Firebase on startup
async function loadQuestionsFromFirebase() {
  try {
    const snapshot = await database.ref('survey_questions').once('value');
    const data = snapshot.val();
    if (data) {
      aspekList = data;
      console.log("✅ Pertanyaan berhasil dimuat dari Firebase");
    }
  } catch (error) {
    console.log("⚠️ Menggunakan pertanyaan default:", error);
  }
}

// Admin Functions
function openAdmin() {
  document.getElementById('adminModal').classList.remove('hidden');
  if (isAdminLoggedIn) {
    showAdminContent();
  } else {
    showAdminLogin();
  }
}

function closeAdmin() {
  document.getElementById('adminModal').classList.add('hidden');
}

function showAdminLogin() {
  document.getElementById('adminLogin').classList.remove('hidden');
  document.getElementById('adminContent').classList.add('hidden');
}

function showAdminContent() {
  document.getElementById('adminLogin').classList.add('hidden');
  document.getElementById('adminContent').classList.remove('hidden');
  renderAdminEditor();
}

function loginAdmin() {
  const password = document.getElementById('adminPasswordInput').value;
  if (password === ADMIN_PASSWORD) {
    isAdminLoggedIn = true;
    showAdminContent();
    playKlik();
  } else {
    alert('❌ Password salah!');
    document.getElementById('adminPasswordInput').value = '';
  }
}

function renderAdminEditor() {
  const adminEditor = document.getElementById('adminEditor');
  adminEditor.innerHTML = '';
  
  aspekList.forEach((aspek, aspekIndex) => {
    const sectionHTML = `
      <div class="admin-section">
        <h3>📝 ${aspek.judul}</h3>
        ${aspek.pertanyaan.map((pertanyaan, qIndex) => `
          <div class="question-editor">
            <label>Pertanyaan ${qIndex + 1}:</label>
            <input type="text" 
              class="question-input" 
              data-aspek="${aspekIndex}" 
              data-question="${qIndex}"
              value="${pertanyaan}"
              placeholder="Masukkan pertanyaan...">
          </div>
        `).join('')}
      </div>
    `;
    adminEditor.innerHTML += sectionHTML;
  });
}

async function saveQuestions() {
  // Collect all updated questions
  const inputs = document.querySelectorAll('.question-input');
  const updatedAspekList = JSON.parse(JSON.stringify(aspekList)); // Deep copy
  
  inputs.forEach(input => {
    const aspekIndex = parseInt(input.dataset.aspek);
    const questionIndex = parseInt(input.dataset.question);
    updatedAspekList[aspekIndex].pertanyaan[questionIndex] = input.value.trim();
  });
  
  // Validate - ensure no empty questions
  let hasEmpty = false;
  updatedAspekList.forEach(aspek => {
    aspek.pertanyaan.forEach(pertanyaan => {
      if (!pertanyaan.trim()) {
        hasEmpty = true;
      }
    });
  });
  
  if (hasEmpty) {
    alert('⚠️ Semua pertanyaan harus diisi!');
    return;
  }
  
  try {
    // Save to Firebase
    await database.ref('survey_questions').set(updatedAspekList);
    
    // Update local data
    aspekList = updatedAspekList;
    
    alert('✅ Pertanyaan berhasil disimpan!');
    playSelesai();
    closeAdmin();
  } catch (error) {
    console.error('Error saving questions:', error);
    alert('❌ Gagal menyimpan pertanyaan. Coba lagi.');
  }
}

// Initialize Survey
function renderStep(step) {
  const aspek = aspekList[step];
  
  stepContainer.innerHTML = `
    <h3 class="step-title">${aspek.judul}</h3>
  `;
  
  aspek.pertanyaan.forEach((pertanyaan, index) => {
    const questionId = `${aspek.prefix}${index + 1}`;
    jawaban[questionId] = jawaban[questionId] || 0;
    
    stepContainer.innerHTML += `
      <div class="question-card">
        <div class="question-text">${pertanyaan}</div>
        <div class="rating-container">
          ${[...Array(10)].map((_, i) => `
            <button type="button" 
              class="rating-button ${jawaban[questionId] === i + 1 ? 'active' : ''}"
              data-id="${questionId}" 
              data-value="${i + 1}">
              ${i + 1}
            </button>
          `).join('')}
        </div>
      </div>
    `;
  });
  
  // Add event listeners
  document.querySelectorAll('.rating-button').forEach(button => {
    button.addEventListener('click', (e) => {
      const questionId = e.target.dataset.id;
      const value = parseInt(e.target.dataset.value);
      
      jawaban[questionId] = value;
      
      e.target.classList.add('clicked');
      setTimeout(() => e.target.classList.remove('clicked'), 600);
      
      document.querySelectorAll(`[data-id="${questionId}"]`).forEach(btn => btn.classList.remove('active'));
      e.target.classList.add('active');
      
      playKlik();
    });

    button.addEventListener('mousemove', function(e) {
      const rect = this.getBoundingClientRect();
      const centerX = rect.left + rect.width / 2;
      const centerY = rect.top + rect.height / 2;
      const deltaX = e.clientX - centerX;
      const deltaY = e.clientY - centerY;
      
      this.style.transform = `translate(${deltaX * 0.1}px, ${deltaY * 0.1}px) scale(1.15) rotate(5deg) translateY(-5px)`;
    });
    
    button.addEventListener('mouseleave', function() {
      if (!this.classList.contains('active')) {
        this.style.transform = '';
      }
    });
  });
  
  prevBtn.classList.toggle('hidden', step === 0);
  nextBtn.textContent = step === aspekList.length - 1 ? 'Selesai →' : 'Selanjutnya →';
  updateProgress();
}

function updateProgress() {
  const progress = ((currentStep + 1) / aspekList.length) * 100;
  document.getElementById('progressBar').style.width = `${progress}%`;
  document.getElementById('progressText').textContent = `Langkah ${currentStep + 1} dari ${aspekList.length}`;
}

// Navigation
nextBtn.addEventListener('click', () => {
  if (currentStep < aspekList.length - 1) {
    currentStep++;
    renderStep(currentStep);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  } else {
    stepContainer.style.display = 'none';
    document.querySelector('.navigation').style.display = 'none';
    document.querySelector('.progress-container').style.display = 'none';
    commentSection.classList.remove('hidden');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
  playKlik();
});

prevBtn.addEventListener('click', () => {
  if (currentStep > 0) {
    currentStep--;
    renderStep(currentStep);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
  playKlik();
});

// Form Submission
document.getElementById('surveyForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const submitBtn = document.getElementById('submitBtn');
  const komentarField = document.querySelector('[name="komentar"]');
  
  submitBtn.disabled = true;
  submitBtn.textContent = 'Mengirim...';
  
  const hasil = aspekList.map(aspek => {
    let total = 0;
    for (let i = 1; i <= 5; i++) {
      total += jawaban[`${aspek.prefix}${i}`] * 10;
    }
    return Math.round(total / 5);
  });
  
  const dataKirim = {
    waktu: new Date().toISOString(),
    komentar: komentarField.value,
    hasil: {},
    jawaban: { ...jawaban }
  };
  
  aspekList.forEach((aspek, index) => {
    dataKirim.hasil[aspek.prefix] = hasil[index];
  });
  
  try {
    await database.ref('respon_survei').push(dataKirim);
    playSelesai();
    
    submitBtn.textContent = '✓ Terkirim! Akan reset dalam 15 detik...';
    
    setTimeout(() => {
      document.getElementById('surveySection').classList.add('hidden');
      resultSection.classList.remove('hidden');
      showResults(hasil);

      let timeLeft = 15;
      const countdown = setInterval(() => {
        submitBtn.textContent = `✓ Terkirim! Akan reset dalam ${timeLeft} detik...`;
        const countdownText = document.getElementById('countdownText');
        if (countdownText) {
          countdownText.textContent = `Halaman ini akan otomatis kembali ke awal dalam ${timeLeft} detik.`;
        }
        timeLeft--;

        if (timeLeft < 0) {
          clearInterval(countdown);
          location.reload();
        }
      }, 1000);
    }, 1000);
    
  } catch (error) {
    console.error('Error:', error);
    alert('Terjadi kesalahan. Silakan coba lagi.');
    submitBtn.disabled = false;
    submitBtn.textContent = 'Kirim Survei';
  }
});

// Show Results Chart
function showResults(hasil) {
  const ctx = document.getElementById('resultChart').getContext('2d');
  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: aspekList.map(a => a.judul),
      datasets: [{
        data: hasil,
        backgroundColor: ['#667eea','#764ba2','#f093fb','#f5576c','#4facfe'],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'bottom',
          labels: { padding: 20, usePointStyle: true }
        }
      }
    }
  });
}

// Load Welcome Statistics
async function loadWelcomeStats() {
  try {
    const snapshot = await database.ref('respon_survei').once('value');
    const data = snapshot.val();
    const totalEl = document.getElementById('totalResponden');
    const avgEl = document.getElementById('avgRating');

    if (!data) {
      totalEl.textContent = '0';
      avgEl.textContent = '-';
      return;
    }
    
    const responses = Object.values(data);
    const totalResponden = responses.length;
    const totals = [0,0,0,0,0];
    responses.forEach(r => {
      if (r.hasil) {
        totals[0] += r.hasil.keramahan || 0;
        totals[1] += r.hasil.fasilitas || 0;
        totals[2] += r.hasil.koleksi || 0;
        totals[3] += r.hasil.kebersihan || 0;
        totals[4] += r.hasil.layanan || 0;
      }
    });
    const averages = totals.map(t => Math.round(t / totalResponden));
    const overallAvg = Math.round(averages.reduce((a,b)=>a+b,0)/5);
    totalEl.textContent = totalResponden;
    avgEl.textContent = overallAvg + '%';

    const ctx = document.getElementById('welcomeChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Keramahan','Fasilitas','Koleksi','Kebersihan','Layanan'],
        datasets: [{
          label: 'Rata-rata Kepuasan (%)',
          data: averages,
          backgroundColor: [
            'rgba(102,126,234,0.8)',
            'rgba(118,75,162,0.8)',
            'rgba(240,147,251,0.8)',
            'rgba(245,87,108,0.8)',
            'rgba(79,172,254,0.8)'
          ],
          borderRadius: 8,
          borderSkipped: false
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            ticks: { callback: (v)=> v + '%' }
          }
        }
      }
    });
  } catch (err) {
    console.error('Error loading stats:', err);
  }
}

function mulaiSurvei() {
  document.getElementById('welcomeScreen').classList.add('hidden');
  document.getElementById('surveySection').classList.remove('hidden');
  renderStep(currentStep);
}

function isMobileDevice() {
  return /Mobi|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}

// Close modal when clicking outside
document.getElementById('adminModal').addEventListener('click', (e) => {
  if (e.target.id === 'adminModal') {
    closeAdmin();
  }
});

// Keyboard shortcuts for admin
document.addEventListener('keydown', (e) => {
  if (e.ctrlKey && e.shiftKey && e.key === 'A') {
    e.preventDefault();
    openAdmin();
  }
  if (e.key === 'Escape' && !document.getElementById('adminModal').classList.contains('hidden')) {
    closeAdmin();
  }
});

// Initialize application
window.addEventListener('DOMContentLoaded', async () => {
  // Load questions from Firebase first
  await loadQuestionsFromFirebase();
  
  const statsContainer = document.getElementById('statsContainer');
  const chartContainer = document.querySelector('#welcomeScreen .chart-container');
  if (isMobileDevice()) {
    if (statsContainer) statsContainer.style.display = 'none';
    if (chartContainer) chartContainer.style.display = 'none';
  } else {
    if (statsContainer) statsContainer.style.display = 'grid';
    if (chartContainer) chartContainer.style.display = 'block';
    loadWelcomeStats();
  }
});
</script>
</body>
</html>
